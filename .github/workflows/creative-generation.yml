name: Creative Content Generation

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        default: 'creative-project'
      content_type:
        description: 'Content type to generate'
        required: true
        type: choice
        options:
        - image
        - video
        - music
        - 3d
        - all
      prompt:
        description: 'Generation prompt'
        required: true
        default: 'Beautiful landscape'

env:
  MCP_CLOUD_RUN_URL: https://mcp-veo3-fast-only-20250709-220921-05b3effb-zl3xx5lsaq-uc.a.run.app

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        # Install Claude Code via curl
        curl -fsSL https://claude.ai/install.sh | bash
        export PATH="$HOME/.local/bin:$PATH"
        
        # Install Python dependencies
        pip install -r requirements.txt
        
    - name: Create Kamui MCP config
      run: |
        mkdir -p ~/.claude
        echo "Creating Kamui MCP config at: ~/.claude/mcp-kamuicode.json"
        cat > ~/.claude/mcp-kamuicode.json << 'EOF'
        {
          "mcpServers": {
            "t2i-google-imagen3": {
              "type": "http",
              "url": "${{ env.MCP_CLOUD_RUN_URL }}/t2i/google/imagen",
              "description": "Google Imagen 3 Text-to-Image Generation"
            },
            "t2m-google-lyria": {
              "type": "http", 
              "url": "${{ env.MCP_CLOUD_RUN_URL }}/t2m/google/lyria",
              "description": "Google Lyria Text-to-Music Generation"
            },
            "t2v-fal-veo3-fast": {
              "type": "http",
              "url": "${{ env.MCP_CLOUD_RUN_URL }}/t2v/fal/veo3/fast", 
              "description": "Fal.ai Veo3 Fast Text-to-Video Generation"
            },
            "i2v-fal-hailuo-02-pro": {
              "type": "http",
              "url": "${{ env.MCP_CLOUD_RUN_URL }}/i2v/fal/minimax/hailuo-02/pro",
              "description": "Fal.ai Hailuo-02 Pro Image-to-Video Generation"
            }
          }
        }
        EOF
        echo "Config file created. Verifying:"
        ls -la ~/.claude/
        cat ~/.claude/mcp-kamuicode.json
        
    - name: Run Creative Factory tests
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        python3 test_kamui.py
        
    - name: Generate content with Kamui Code MCP
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        echo "ðŸŽ¨ Generating ${{ github.event.inputs.content_type }} content..."
        echo "ðŸ“ Prompt: ${{ github.event.inputs.prompt }}"
        python3 src/generate.py \
          --type "${{ github.event.inputs.content_type }}" \
          --prompt "${{ github.event.inputs.prompt }}"
        
    - name: List generated files
      run: |
        echo "ðŸ“ Generated files:"
        find outputs/ -type f -name "*" || echo "No files generated"
        
    - name: Upload generated assets
      uses: actions/upload-artifact@v4
      with:
        name: generated-${{ github.event.inputs.project_name }}-${{ github.event.inputs.content_type }}
        path: outputs/
        if-no-files-found: warn